<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading Expert Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .signal-long {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .signal-short {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        .signal-neutral {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="gradient-bg text-white py-6 px-4">
        <div class="max-w-7xl mx-auto">
            <div class="flex items-center space-x-3">
                <i data-lucide="brain" class="w-8 h-8"></i>
                <h1 class="text-3xl font-bold">AI Trading Expert Advisor</h1>
            </div>
            <p class="mt-2 text-blue-100">Professional AI-powered trading signals with real-time analysis</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Configuration Panel -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 card-hover">
            <h2 class="text-xl font-semibold mb-6 flex items-center">
                <i data-lucide="settings" class="w-5 h-5 mr-2 text-blue-600"></i>
                Trading Configuration
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Symbol Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Trading Symbol</label>
                    <select id="symbol" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Loading symbols...</option>
                    </select>
                </div>

                <!-- Timeframe Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Timeframe</label>
                    <select id="timeframe" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="1">M1 (1 Minute)</option>
                        <option value="5">M5 (5 Minutes)</option>
                        <option value="15">M15 (15 Minutes)</option>
                        <option value="30">M30 (30 Minutes)</option>
                        <option value="16385" selected>H1 (1 Hour)</option>
                        <option value="16388">H4 (4 Hours)</option>
                        <option value="16408">D1 (Daily)</option>
                    </select>
                </div>

                <!-- AI Provider Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">AI Provider</label>
                    <select id="aiProvider" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="anthropic">Anthropic Claude</option>
                        <option value="openai">OpenAI GPT</option>
                        <option value="deepseek">DeepSeek AI</option>
                        <option value="grok">Grok Code Fast 1</option>
                        <option value="kilo_code">Kilo Code Agent</option>
                    </select>
                </div>

                <!-- Risk Percentage -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Risk per Trade (%)</label>
                    <input type="number" id="riskPercent" value="1.0" step="0.1" min="0.1" max="5.0"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="flex space-x-4 mt-6">
                <button id="startAnalysis" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium flex items-center space-x-2 transition-colors">
                    <i data-lucide="play" class="w-4 h-4"></i>
                    <span>Start Analysis</span>
                </button>
                <button id="stopAnalysis" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-medium flex items-center space-x-2 transition-colors" disabled>
                    <i data-lucide="square" class="w-4 h-4"></i>
                    <span>Stop Analysis</span>
                </button>
                <button id="clearResults" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-medium flex items-center space-x-2 transition-colors">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    <span>Clear Results</span>
                </button>
            </div>
        </div>

        <!-- Status Panel -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 card-hover">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i data-lucide="activity" class="w-5 h-5 mr-2 text-green-600"></i>
                System Status
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="flex items-center space-x-3">
                    <div id="mt5Status" class="w-3 h-3 rounded-full bg-red-500"></div>
                    <span class="text-sm font-medium">MT5 Connection</span>
                    <span id="mt5StatusText" class="text-sm text-gray-600">Disconnected</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="aiStatus" class="w-3 h-3 rounded-full bg-red-500"></div>
                    <span class="text-sm font-medium">AI Service</span>
                    <span id="aiStatusText" class="text-sm text-gray-600">Not Connected</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="analysisStatus" class="w-3 h-3 rounded-full bg-gray-500 pulse-animation"></div>
                    <span class="text-sm font-medium">Analysis</span>
                    <span id="analysisStatusText" class="text-sm text-gray-600">Ready</span>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Current Signal -->
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                <h2 class="text-xl font-semibold mb-6 flex items-center">
                    <i data-lucide="target" class="w-5 h-5 mr-2 text-purple-600"></i>
                    Current Trading Signal
                </h2>

                <div id="currentSignal" class="space-y-4">
                    <div class="text-center py-12">
                        <i data-lucide="clock" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
                        <p class="text-gray-500">No signal generated yet</p>
                        <p class="text-sm text-gray-400">Click "Start Analysis" to begin</p>
                    </div>
                </div>
            </div>

            <!-- Market Analysis -->
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                <h2 class="text-xl font-semibold mb-6 flex items-center">
                    <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-blue-600"></i>
                    Market Analysis
                </h2>

                <div id="marketAnalysis" class="space-y-4">
                    <div class="text-center py-12">
                        <i data-lucide="trending-up" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
                        <p class="text-gray-500">No analysis available</p>
                        <p class="text-sm text-gray-400">Analysis will appear here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Log -->
        <div class="bg-white rounded-xl shadow-lg p-6 mt-8 card-hover">
            <h2 class="text-xl font-semibold mb-6 flex items-center">
                <i data-lucide="file-text" class="w-5 h-5 mr-2 text-indigo-600"></i>
                Analysis Log
            </h2>

            <div id="analysisLog" class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto font-mono text-sm">
                <div class="text-gray-500 italic">Analysis log will appear here...</div>
            </div>
        </div>
    </div>

    <!-- Token Usage Footer -->
    <footer class="bg-gray-800 text-white py-4 px-4 mt-8">
        <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                <div>
                    <div class="text-sm text-gray-400">Input Tokens</div>
                    <div class="text-lg font-semibold text-blue-400" id="inputTokens">0</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">Output Tokens</div>
                    <div class="text-lg font-semibold text-green-400" id="outputTokens">0</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">Total Tokens</div>
                    <div class="text-lg font-semibold text-purple-400" id="totalTokens">0</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">TPM Available</div>
                    <div class="text-lg font-semibold text-yellow-400" id="tpmAvailable">50,000</div>
                </div>
            </div>
            <div class="mt-4 text-center text-sm text-gray-400">
                <span id="aiProviderDisplay">No AI provider selected</span> |
                <span id="lastUpdate">Not updated yet</span>
            </div>
        </div>
    </footer>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="text-lg font-medium">Analyzing market data...</span>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Global variables
        let analysisInterval;
        let isAnalyzing = false;
        let lastApiCallTime = 0;
        let apiCallQueue = [];
        let isProcessingQueue = false;

        // DOM elements
        const startBtn = document.getElementById('startAnalysis');
        const stopBtn = document.getElementById('stopAnalysis');
        const clearBtn = document.getElementById('clearResults');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const analysisLog = document.getElementById('analysisLog');

        // Status indicators
        const mt5Status = document.getElementById('mt5Status');
        const mt5StatusText = document.getElementById('mt5StatusText');
        const aiStatus = document.getElementById('aiStatus');
        const aiStatusText = document.getElementById('aiStatusText');
        const analysisStatus = document.getElementById('analysisStatus');
        const analysisStatusText = document.getElementById('analysisStatusText');

        // Event listeners
        startBtn.addEventListener('click', startAnalysis);
        stopBtn.addEventListener('click', stopAnalysis);
        clearBtn.addEventListener('click', clearResults);

        // Functions
        function startAnalysis() {
            if (isAnalyzing) return;

            isAnalyzing = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            analysisStatus.className = 'w-3 h-3 rounded-full bg-blue-500 pulse-animation';
            analysisStatusText.textContent = 'Running';

            // Get configuration
            const config = {
                symbol: document.getElementById('symbol').value,
                timeframe: parseInt(document.getElementById('timeframe').value),
                aiProvider: document.getElementById('aiProvider').value,
                riskPercent: parseFloat(document.getElementById('riskPercent').value)
            };

            // Calculate analysis interval based on timeframe
            const timeframeMinutes = getTimeframeMinutes(config.timeframe);
            const analysisIntervalMs = timeframeMinutes * 60 * 1000; // Exact timeframe interval

            // Start analysis loop
            runAnalysis(config);
            analysisInterval = setInterval(() => runAnalysis(config), analysisIntervalMs);

            logMessage(`Analysis started with ${Math.round(analysisIntervalMs / 1000)}s interval (${timeframeMinutes}min timeframe)`, 'success');
        }

        function getTimeframeMinutes(timeframe) {
            const timeframeMap = {
                1: 1,      // M1
                5: 5,      // M5
                15: 15,    // M15
                30: 30,    // M30
                16385: 60, // H1
                16388: 240, // H4
                16408: 1440 // D1
            };
            return timeframeMap[timeframe] || 60; // Default to 60 minutes (H1)
        }

        function stopAnalysis() {
            isAnalyzing = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            analysisStatus.className = 'w-3 h-3 rounded-full bg-gray-500';
            analysisStatusText.textContent = 'Stopped';

            // Clear the analysis interval
            if (analysisInterval) {
                clearInterval(analysisInterval);
            }

            // Clear any pending API calls
            apiCallQueue = [];
            isProcessingQueue = false;

            logMessage('Analysis stopped and API call queue cleared', 'info');
        }

        function clearResults() {
            document.getElementById('currentSignal').innerHTML = `
                <div class="text-center py-12">
                    <i data-lucide="clock" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
                    <p class="text-gray-500">No signal generated yet</p>
                    <p class="text-sm text-gray-400">Click "Start Analysis" to begin</p>
                </div>
            `;
            document.getElementById('marketAnalysis').innerHTML = `
                <div class="text-center py-12">
                    <i data-lucide="trending-up" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
                    <p class="text-gray-500">No analysis available</p>
                    <p class="text-sm text-gray-400">Analysis will appear here</p>
                </div>
            `;
            analysisLog.innerHTML = '<div class="text-gray-500 italic">Analysis log will appear here...</div>';
            lucide.createIcons();
        }

        async function runAnalysis(config) {
            // Add to queue for rate limiting
            apiCallQueue.push(config);

            if (!isProcessingQueue) {
                processApiCallQueue();
            }
        }

        async function processApiCallQueue() {
            if (apiCallQueue.length === 0 || !isAnalyzing) {
                isProcessingQueue = false;
                return;
            }

            isProcessingQueue = true;

            while (apiCallQueue.length > 0 && isAnalyzing) {
                const config = apiCallQueue.shift();
                const now = Date.now();

                // Rate limiting: ensure at least 60 seconds between API calls for safety
                const timeSinceLastCall = now - lastApiCallTime;
                const minIntervalMs = 60000; // 60 seconds minimum between API calls
                if (timeSinceLastCall < minIntervalMs) {
                    const waitTime = minIntervalMs - timeSinceLastCall;
                    logMessage(`Rate limiting: waiting ${Math.round(waitTime / 1000)}s before next API call`, 'info');
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }

                try {
                    loadingOverlay.classList.remove('hidden');
                    lastApiCallTime = Date.now();

                    const response = await fetch('/run_ai_analysis', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(config)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        updateUI(result);
                        updateStatus('success');
                        logMessage(`Analysis completed successfully`, 'success');
                    } else {
                        if (result.error && result.error.includes('rate_limit_exceeded')) {
                            logMessage(`Rate limit exceeded, retrying in 60 seconds`, 'error');
                            // Put back in queue and wait longer
                            apiCallQueue.unshift(config);
                            await new Promise(resolve => setTimeout(resolve, 60000));
                            continue;
                        } else {
                            updateStatus('error', result.error);
                            logMessage(`Error: ${result.error}`, 'error');
                        }
                    }

                } catch (error) {
                    updateStatus('error', error.message);
                    logMessage(`Error: ${error.message}`, 'error');
                } finally {
                    loadingOverlay.classList.add('hidden');
                }

                // Small delay between processing queue items
                if (apiCallQueue.length > 0) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            isProcessingQueue = false;
        }

        function updateUI(result) {
            // Update current signal
            const signalHtml = generateSignalHTML(result.signal);
            document.getElementById('currentSignal').innerHTML = signalHtml;

            // Update market analysis
            const analysisHtml = generateAnalysisHTML(result.analysis);
            document.getElementById('marketAnalysis').innerHTML = analysisHtml;

            // Update token usage
            updateTokenUsage(result.token_usage);

            // Log the analysis
            logMessage(`Analysis completed for ${result.signal.symbol} at ${new Date().toLocaleTimeString()}`, 'success');

            // Re-initialize icons
            lucide.createIcons();
        }

        function updateTokenUsage(tokenUsage) {
            if (tokenUsage) {
                document.getElementById('inputTokens').textContent = tokenUsage.input_tokens.toLocaleString();
                document.getElementById('outputTokens').textContent = tokenUsage.output_tokens.toLocaleString();
                document.getElementById('totalTokens').textContent = tokenUsage.total_tokens.toLocaleString();

                // Update TPM available (assuming 50k TPM limit, reset daily)
                const tpmAvailable = 50000 - tokenUsage.total_tokens;
                document.getElementById('tpmAvailable').textContent = Math.max(0, tpmAvailable).toLocaleString();

                // Update provider display
                const provider = document.getElementById('aiProvider').value;
                const providerNames = {
                    'anthropic': 'Anthropic Claude',
                    'openai': 'OpenAI GPT',
                    'deepseek': 'DeepSeek AI',
                    'grok': 'Grok Code Fast 1',
                    'kilo_code': 'Kilo Code Agent'
                };
                document.getElementById('aiProviderDisplay').textContent = providerNames[provider] || 'Unknown Provider';

                // Update last update time
                document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
            }
        }

        function generateSignalHTML(signal) {
            const signalClass = signal.signal_type === 'LONG' ? 'signal-long' :
                              signal.signal_type === 'SHORT' ? 'signal-short' : 'signal-neutral';

            return `
                <div class="rounded-lg p-4 text-white ${signalClass}">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">${signal.symbol} Signal</h3>
                        <span class="px-3 py-1 rounded-full text-sm font-medium bg-white bg-opacity-20">
                            ${signal.confidence} Confidence
                        </span>
                    </div>

                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span>Signal:</span>
                            <span class="font-semibold">${signal.signal_type}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Entry Price:</span>
                            <span class="font-mono">${signal.entry_price.toFixed(5)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Position Size:</span>
                            <span class="font-mono">${signal.position_size.toFixed(2)} lots</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Stop Loss:</span>
                            <span class="font-mono">${signal.stop_loss.toFixed(5)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Take Profit 1:</span>
                            <span class="font-mono">${signal.take_profit_1.toFixed(5)}</span>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-semibold mb-2">AI Reasoning:</h4>
                    <p class="text-sm text-gray-700">${signal.reasoning}</p>
                </div>
            `;
        }

        function generateAnalysisHTML(analysis) {
            return `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <div class="text-sm text-blue-600 font-medium">ATR</div>
                            <div class="text-lg font-semibold text-blue-800">${analysis.atr.toFixed(6)}</div>
                            <div class="text-xs text-blue-600">${analysis.volatility_level}</div>
                        </div>
                        <div class="p-3 bg-green-50 rounded-lg">
                            <div class="text-sm text-green-600 font-medium">RSI</div>
                            <div class="text-lg font-semibold text-green-800">${analysis.rsi.toFixed(2)}</div>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-lg">
                            <div class="text-sm text-purple-600 font-medium">MACD</div>
                            <div class="text-lg font-semibold text-purple-800">${analysis.macd.toFixed(6)}</div>
                            <div class="text-xs text-purple-600">Signal: ${analysis.macd_signal.toFixed(6)}</div>
                        </div>
                        <div class="p-3 bg-orange-50 rounded-lg">
                            <div class="text-sm text-orange-600 font-medium">CCI</div>
                            <div class="text-lg font-semibold text-orange-800">${analysis.cci.toFixed(2)}</div>
                        </div>
                    </div>

                    <div class="p-3 bg-indigo-50 rounded-lg">
                        <div class="text-sm text-indigo-600 font-medium">Market Bias</div>
                        <div class="text-lg font-semibold text-indigo-800 capitalize">${analysis.bias}</div>
                    </div>
                </div>
            `;
        }

        function updateStatus(type, message = '') {
            if (type === 'success') {
                mt5Status.className = 'w-3 h-3 rounded-full bg-green-500';
                mt5StatusText.textContent = 'Connected';
                aiStatus.className = 'w-3 h-3 rounded-full bg-green-500';
                aiStatusText.textContent = 'Active';
            } else if (type === 'error') {
                aiStatus.className = 'w-3 h-3 rounded-full bg-red-500';
                aiStatusText.textContent = 'Error';
                logMessage(`Error: ${message}`, 'error');
            }
        }

        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-red-600' :
                             type === 'success' ? 'text-green-600' : 'text-gray-600';

            analysisLog.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            analysisLog.scrollTop = analysisLog.scrollHeight;
        }

        // Load available symbols from MT5
        async function loadSymbols() {
            try {
                const response = await fetch('/get_symbols');
                const data = await response.json();

                if (response.ok && data.symbols) {
                    const symbolSelect = document.getElementById('symbol');
                    symbolSelect.innerHTML = '<option value="">Select a symbol...</option>';

                    data.symbols.forEach(symbol => {
                        const option = document.createElement('option');
                        option.value = symbol.name;
                        option.textContent = `${symbol.name} - ${symbol.description || symbol.name}`;
                        symbolSelect.appendChild(option);
                    });

                    // Set default to first available symbol
                    if (data.symbols.length > 0) {
                        symbolSelect.value = data.symbols[0].name;
                    }

                    logMessage(`Loaded ${data.symbols.length} trading symbols`, 'success');
                } else {
                    logMessage('Failed to load symbols: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                logMessage('Error loading symbols: ' + error.message, 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('AI Trading Expert Advisor initialized', 'success');
            loadSymbols();
        });
    </script>
</body>
</html>